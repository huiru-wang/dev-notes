---
title: 微服务：流量治理和降级熔断
category: 分布式系统
tags:
  - MicroService
  - Sentinel
publishedAt: 2024-10-01
description: 微服务架构中的流量治理策略和组件的特点，以及限流算法
---

# 服务流量治理策略

- **限流是防御**：通过算法与规则控制流量，避免系统崩溃。制请求的速率或数量，防止系统因流量过载而崩溃。其核心目标是 **保护系统资源**，确保核心功能在高并发下仍能稳定运行；
- **降级是妥协**：在资源不足时优先保障核心业务，牺牲次要功能。其核心目标是 **丢车保帅**；
- **熔断是止损**：下游服务不可用或性能恶化时，主动或根据指标切断对下游服务的依赖，防止雪崩效应扩散，核心目标是：<font color="#f79646">快速失败</font>

>限流通常是预先设定好的既定策略，但也不是绝对的，比如sentinel的自适应策略可以根据`load1`、`CPU利用率`等指标触发对系统流量的控制；
  降级和熔断的策略则是根据特定的触发条件，如慢调用（RT）、异常的数量或比例等；

# 流量治理组件的特点

1. 能够提供最基础的流量控制，如QPS、线程数等；
2. 提供多种拒绝策略：
	1. 如快速失败、排队等待、根据热点参数限流等；
	2. 根据特定的触发条件，执行降级、熔断；如慢调用次数、CPU利用率达到一定阈值，触发对应的降级；
3. 流量控制策略的持久化；策略通常是长期的，不能只是内存存储，每次启动重新配置；通常会使用配置中心来搭配；如Nacos;
4. 动态配置和热更新：限流、降级策略需要随时可以修改；
5. 非功能性特点：
	1. 性能；
	2. 高可用；
	3. 扩展性；比如规则配置的持久化数据源扩展（Zookeeper、Nacos）、支持的限流场景扩展（HTTP、Dubbo等）

# 分布式限流

在微服务的架构中，服务都是集群化的，为了能够更准确的限制整体的流量，就需要分布式限流。如果是单机限流，如果流量的分配不均匀，整体上的限流水平就会被破坏。

分布式限流组件的条件：
- 组件需要能够集中统计总的流量；
- 组件需要能够分配流量；


# 限流的算法及实现

常见算法及适用场景：

| **算法**      | **算法**                                  | **优缺点**                                      |
| ----------- | --------------------------------------- | -------------------------------------------- |
| **固定窗口计数器** | 统计固定时间窗口（如1秒）内的请求数，超限则拒绝。               | 实现简单，但存在临界时间点突发流量问题（如窗口切换瞬间峰值）。              |
| **滑动窗口**    | 将时间划分为更细粒度的小窗口，动态统计最近N个小窗口的总请求数。        | 缓解固定窗口的临界问题，精度更高，但内存开销较大。                    |
| **漏桶算法**    | 以恒定速率处理请求（如水从漏桶流出），超限请求排队或丢弃。           | 平滑流量，避免突发压力，但无法应对合理突发（如冷启动预热）。               |
| **令牌桶算法**   | 系统按固定速率生成令牌，请求需获取令牌才能处理，允许突发流量（桶内令牌积累）。 | 兼顾流量平滑与突发适应，是工业界最常用算法（如Guava RateLimiter）。   |
| **自适应限流**   | 根据系统实时负载（如CPU、延迟）动态调整阈值（如TCP拥塞控制）。      | 灵活应对复杂场景，但实现复杂（如Netflix Adaptive Throttling） |




