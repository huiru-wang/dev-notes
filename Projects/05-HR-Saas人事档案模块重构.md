---
title: 「Project」人事平台花名册档案模块重构设计与实现
category: project
tags:
  - project
publishedAt: 2024-11-10
description: 由于历史原因和前期的产品快速迭代，人事业务中最核心的人事档案模块，代码开始变得越来越腐化，逐渐暴露出各种问题：1. 新人使用、接手、迭代的成本越来越高；2. 代码架构不合理，难以支撑更复杂的产品逻辑。这是这个人事档案重构项目开启的一个背景。
---

# 为什么要重构？

1. 人事的档案随着历史发展，存储一直是异构的，底层有多张表，还有一部分数据是存储在外部服务。这些数据一起构成了一个员工的档案；上层服务一直在理解这些存储，获取档案时，还需要理解哪个字段在哪个表，开发复杂度、新人理解成本都非常高；
2. 在系统的架构分层中，没有统一的档案域的读写入口，其他模块在执行档案的读写甚至会直接操作某个表进行读写。
3. 读写入口40+，且多个入口含有不同的特殊逻辑。新人接手成本高；

# 急需解决的核心问题

1. <font color="#f79646">屏蔽存储层异构</font>，上层无感知接入档案域读写；
	1. 人事档案对外提供的档案查询和写入，都只是key-value的结构，不感知底层存储；
	2. 实际底层存储是异构的，存储在不同的表中、不同的服务中；
2. <font color="#f79646">40+的流量入口</font>切换到新逻辑，如何保证逻辑的正确性，线上业务无影响？或做到影响可控，随时切换回旧逻辑；
	1. 历史遗留原因，档案的写入口很多，且不同入口含有一些特殊逻辑；
	2. 首先是要足够熟悉业务；避免重构后有业务上的错误、遗漏；
	3. 其次要有一套机制，能够做到<font color="#f79646">数据对账</font>；

# 模块分层设计

![](/images/hr-saas-roster-architecture.png)

1. 统一档案域的数据模型，所有档案的更新入口模型只有一套；
2. 隔离底层存储，增加数据路由，配置化的方式，将不同的档案字段，路由到其所在的真实存储，执行读写。

# 对账逻辑设计

![](/images/hr-saas-roster-data-check.png)

为什么需要这种对账：对于图中的「旧逻辑」，已经无法（或者说成本很高）去梳理内部的业务逻辑了，包含了太多的特殊逻辑，以及某些逻辑是否还需要都无法确定，因此<font color="#f79646">干脆直接将「旧逻辑」当成一个黑盒</font>，我只关心对应走到「旧逻辑」的流量最终执行完成的数据是什么即可；

整个方案的交付节奏：
1. 开发新逻辑；
2. 开发对账逻辑；
3. 加入切流开关；
4. 发布上线（此时流量是双跑，但真实的写操作是「旧逻辑」触发）；
5. 线上数据对账一段时间，直到所有出现的对账失败的case都修复完成，稳定不会出现失败；
6. 打开「切流开关」，此时要保持<font color="#f79646">灰度放量</font>，将流量慢慢切换到新逻辑；
7. 最终流量切换完成，旧逻辑逐步代码下线；


# 档案模型设计

明确内部的档案领域模型；无论是查询还是写入，上层业务只对接同一个模型；

这里采用松散的设计，不再使用一个大的内存对象来定义每个档案字段；而是：企业元数据 + 员工档案；

1. 对每个企业维护一套档案元数据；企业可以新增自定义字段，只需要在元数据中标识字段来源即可；
2. 对用户的档案只是简单的key-value结构；

将员工数据，填充进企业的档案元数据，构建出员工的档案模型：

![](/images/hr-saas-roster-employee-roster.png)

至此，档案的读写模型已经可以确定：
- 读模型：企业元数据 + 员工档案，构建出带有字段元数据的档案模型；
- 写模型：只需要写入key-value格式的数据；

# 异构存储的路由设计

首先明确的是路由的是什么：路由的是档案的每一个字段；比如（职位、手机号、学历等等），他们都可能在不同的表、甚至不同的服务；

设计的目标：
1. 在上层业务的视角中，<font color="#f79646">不需要理解异构的存储</font>，只有要查询、更新的字段；比如要查询某个字段，不需要关系从哪个表中取哪个字段；
2. 路由层能够准确查询和更新到对应存储；
3. 后续的<font color="#f79646">场景扩展</font>，需要做到轻量化，不改变整体代码逻辑，只需要增加字段，配置化达到效果；

字段路由的2种基本路由结构：
- 针对固定的系统字段，维护在内存中的一个大的枚举中，并约束其所在的真实存储；
- 针对企业的自定义字段，固定路由到自定义字段表；













